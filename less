<?php
/**
 * ğŸ›¡ï¸ HEADLESS SECURITY pentru WordPress + JWT + Woo
 * Cod pentru funcÈ›ionalitate + protecÈ›ie API
 */

/**
 * âœ… BlocheazÄƒ metodele POST, PUT, DELETE dacÄƒ nu eÈ™ti autentificat cu JWT
 */
add_filter('rest_pre_dispatch', function ($result, $server, $request) {
    $method = $request->get_method();
    $jwt_required = in_array($method, ['POST', 'PUT', 'DELETE']);

    // DacÄƒ metoda cere autentificare È™i userul nu e logat (fÄƒrÄƒ JWT valid)
    if ($jwt_required && !is_user_logged_in()) {
        return new WP_Error('rest_forbidden', 'JWT Authentication required.', ['status' => 401]);
    }

    return $result;
}, 10, 3);

/**
 * ğŸ›‘ DezactiveazÄƒ xmlrpc.php complet
 */
add_filter('xmlrpc_enabled', '__return_false');

/**
 * ğŸ” Ascunde complet endpoint-urile pentru utilizatori (GET /wp-json/wp/v2/users)
 */
add_filter('rest_endpoints', function ($endpoints) {
    if (isset($endpoints['/wp/v2/users'])) {
        unset($endpoints['/wp/v2/users']); // lista de utilizatori
    }
    if (isset($endpoints['/wp/v2/users/(?P<id>[\d]+)'])) {
        unset($endpoints['/wp/v2/users/(?P<id>[\d]+)']); // utilizator individual
    }
    return $endpoints;
});

/**
 * ğŸ§¼ CurÄƒÈ›Äƒ rÄƒspunsurile API pentru useri â€” ascunde email, link, descriere
 */
add_filter('rest_prepare_user', function ($response, $user, $request) {
    if (!current_user_can('edit_users')) {
        $data = $response->get_data();
        unset($data['email']);
        unset($data['link']);
        unset($data['description']);
        $response->set_data($data);
    }
    return $response;
}, 10, 3);

/**
 * ğŸ§¼ Ascunde cÃ¢mpuri sensibile din postÄƒri
 */
add_filter('rest_prepare_post', function ($response, $post, $request) {
    $data = $response->get_data();
    unset($data['author']); // ascunde autorul postÄƒrii
    unset($data['meta']);   // ascunde meta fields
    $response->set_data($data);
    return $response;
}, 10, 3);

/**
 * ğŸ§° Exemplu extra: dezactiveazÄƒ alte endpoint-uri (comentarii, media)
 */
// add_filter('rest_endpoints', function ($endpoints) {
//     unset($endpoints['/wp/v2/comments']);
//     unset($endpoints['/wp/v2/media']);
//     return $endpoints;
// });
