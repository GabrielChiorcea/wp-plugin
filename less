<?php
/**
 * 🛡️ HEADLESS SECURITY pentru WordPress + WooCommerce + JWT
 */

/**
 * ✅ Blochează metodele POST, PUT, DELETE dacă nu ești autentificat cu JWT
 */
add_filter('rest_pre_dispatch', function ($result, $server, $request) {
    $method = $request->get_method();
    $jwt_required = in_array($method, ['POST', 'PUT', 'DELETE']);

    if ($jwt_required && !is_user_logged_in()) {
        return new WP_Error('rest_forbidden', 'JWT Authentication required.', ['status' => 401]);
    }

    return $result;
}, 10, 3);

/**
 * 🔐 Blochează accesul la WooCommerce API (GET / POST / DELETE) fără autentificare
 */
add_filter('rest_pre_dispatch', function ($result, $server, $request) {
    $woo_protected_routes = [
        '/wc/v3/orders',
        '/wc/v3/customers',
        '/wc/v3/users',
        '/wc/v3/reports',
        '/wc/v3/coupons',
    ];

    $route = $request->get_route();
    foreach ($woo_protected_routes as $protected) {
        if (strpos($route, $protected) !== false && !is_user_logged_in()) {
            return new WP_Error('rest_forbidden', 'JWT required for WooCommerce data.', ['status' => 401]);
        }
    }

    return $result;
}, 10, 3);

/**
 * 🛑 Dezactivează xmlrpc.php complet
 */
add_filter('xmlrpc_enabled', '__return_false');

/**
 * 🔍 Ascunde complet endpoint-urile pentru utilizatori (GET /wp-json/wp/v2/users)
 */
add_filter('rest_endpoints', function ($endpoints) {
    if (isset($endpoints['/wp/v2/users'])) {
        unset($endpoints['/wp/v2/users']);
    }
    if (isset($endpoints['/wp/v2/users/(?P<id>[\d]+)'])) {
        unset($endpoints['/wp/v2/users/(?P<id>[\d]+)']);
    }
    return $endpoints;
});

/**
 * 🧼 Curăță răspunsurile API pentru useri — ascunde email, link, descriere
 */
add_filter('rest_prepare_user', function ($response, $user, $request) {
    if (!current_user_can('edit_users')) {
        $data = $response->get_data();
        unset($data['email']);
        unset($data['link']);
        unset($data['description']);
        $response->set_data($data);
    }
    return $response;
}, 10, 3);

/**
 * 🧼 Ascunde câmpuri sensibile din postări
 */
add_filter('rest_prepare_post', function ($response, $post, $request) {
    $data = $response->get_data();
    unset($data['author']); // ascunde autorul postării
    unset($data['meta']);   // ascunde meta fields
    $response->set_data($data);
    return $response;
}, 10, 3);
